# 测试存储包装器

<cite>
**本文档引用的文件**
- [storage.go](file://leveldb/testutil/storage.go)
- [storage.go](file://leveldb/storage/storage.go)
- [db_test.go](file://leveldb/db_test.go)
- [testutil_test.go](file://leveldb/testutil_test.go)
</cite>

## 目录
1. [简介](#简介)
2. [核心设计与功能](#核心设计与功能)
3. [方法增强逻辑](#方法增强逻辑)
4. [测试用例与应用场景](#测试用例与应用场景)
5. [总结](#总结)

## 简介
`testutil`包中的`Storage`包装器是为增强可测试性而设计的关键工具。它通过嵌入基础`Storage`接口并添加测试专用字段，提供了对数据库存储层的细粒度控制。该包装器能够模拟各种异常条件，如文件打开失败、读写错误等，从而验证系统在异常情况下的恢复能力。

## 核心设计与功能
`Storage`结构体通过嵌入`storage.Storage`接口实现了对底层存储的包装。它添加了多个测试专用字段，包括错误模拟、随机错误注入、操作计数器和阻塞控制。

```mermaid
classDiagram
class Storage {
+storage.Storage
-path string
-onClose func() (preserve bool, err error)
-onLog func(str string)
-lmu sync.Mutex
-lb bytes.Buffer
-mu sync.Mutex
-rand *rand.Rand
-opens map[uint64]bool
-counters [flattenCount]int
-bytesCounter [flattenCount]int64
-emulatedError [flattenCount]error
-emulatedErrorOnce [flattenCount]bool
-emulatedRandomError [flattenCount]error
-emulatedRandomErrorProb [flattenCount]float64
-stallCond sync.Cond
-stalled [flattenCount]bool
+NewStorage() *Storage
+Log(str string)
+Lock() (storage.Locker, error)
+List(t storage.FileType) ([]storage.FileDesc, error)
+GetMeta() (storage.FileDesc, error)
+SetMeta(fd storage.FileDesc) error
+Open(fd storage.FileDesc) (storage.Reader, error)
+Create(fd storage.FileDesc) (storage.Writer, error)
+Remove(fd storage.FileDesc) error
+Rename(oldfd, newfd storage.FileDesc) error
+Close() error
+ResetCounter(m StorageMode, t storage.FileType)
+Counter(m StorageMode, t storage.FileType) (int, int64)
+EmulateError(m StorageMode, t storage.FileType, err error)
+EmulateErrorOnce(m StorageMode, t storage.FileType, err error)
+EmulateRandomError(m StorageMode, t storage.FileType, prob float64, err error)
+Stall(m StorageMode, t storage.FileType)
+Release(m StorageMode, t storage.FileType)
}
class storage.Storage {
<<interface>>
+Lock() (storage.Locker, error)
+Log(str string)
+SetMeta(fd storage.FileDesc) error
+GetMeta() (storage.FileDesc, error)
+List(t storage.FileType) ([]storage.FileDesc, error)
+Open(fd storage.FileDesc) (storage.Reader, error)
+Create(fd storage.FileDesc) (storage.Writer, error)
+Remove(fd storage.FileDesc) error
+Rename(oldfd, newfd storage.FileDesc) error
+Close() error
}
Storage --> storage.Storage : "嵌入"
```

**图源**
- [storage.go](file://leveldb/testutil/storage.go#L246-L697)

**本节源**
- [storage.go](file://leveldb/testutil/storage.go#L246-L697)

## 方法增强逻辑
`Storage`包装器对`Lock`、`Open`、`List`等方法进行了增强，添加了日志记录、错误模拟触发和资源跟踪功能。

### 锁定操作增强
`Lock`方法在调用底层存储的`Lock`方法后，会记录日志并包装返回的`Locker`，以便在解锁时记录日志。

```mermaid
sequenceDiagram
participant Client
participant Storage
participant UnderlyingStorage
Client->>Storage : Lock()
Storage->>UnderlyingStorage : Lock()
UnderlyingStorage-->>Storage : Locker, error
alt 错误
Storage-->>Client : error
else 成功
Storage->>Storage : logI("storage locked")
Storage->>Storage : 包装Locker
Storage-->>Client : 包装后的Locker
end
```

**图源**
- [storage.go](file://leveldb/testutil/storage.go#L337-L345)

### 文件操作增强
`Open`、`Create`、`Remove`等文件操作方法都添加了错误模拟和日志记录功能。在调用底层方法前，会检查是否需要模拟错误，并在操作完成后记录日志。

```mermaid
flowchart TD
Start([Open]) --> CheckError["检查是否需要模拟错误"]
CheckError --> |需要模拟| ReturnError["返回模拟错误"]
CheckError --> |不需要模拟| Stall["检查是否需要阻塞"]
Stall --> |需要阻塞| Wait["等待释放"]
Stall --> |不需要阻塞| AssertOpen["检查文件是否已打开"]
AssertOpen --> CallUnderlying["调用底层Open方法"]
CallUnderlying --> |成功| LogSuccess["记录成功日志"]
CallUnderlying --> |失败| LogError["记录失败日志"]
LogSuccess --> WrapReader["包装Reader"]
LogSuccess --> End([返回])
LogError --> End
```

**图源**
- [storage.go](file://leveldb/testutil/storage.go#L409-L428)

**本节源**
- [storage.go](file://leveldb/testutil/storage.go#L337-L502)

## 测试用例与应用场景
`Storage`包装器在多个测试用例中被用来验证数据库在异常条件下的行为。

### 模拟文件打开错误
在`TestDB_ManifestWriteError`测试中，通过`EmulateError`方法模拟清单文件的写入和同步错误，验证数据库在元数据更新失败时的恢复能力。

```mermaid
sequenceDiagram
participant Test
participant Storage
participant DB
Test->>Storage : EmulateError(ModeWrite, TypeManifest, "manifest write error")
Test->>DB : compactRangeAtErr(0, "", "", true)
DB->>Storage : Create(manifest file)
Storage->>Storage : 检查是否需要模拟错误
Storage-->>DB : 返回模拟错误
DB-->>Test : 返回错误
Test->>Storage : EmulateError(ModeWrite, TypeManifest, nil)
Test->>DB : Close()
Test->>DB : Open()
DB->>Test : 成功打开数据库
```

**图源**
- [db_test.go](file://leveldb/db_test.go#L1501-L1517)

### 模拟临时读取错误
在`TestDB_TableTransientReadError`测试中，通过`EmulateError`方法模拟表文件的临时读取错误，验证数据库在读取失败时的重试机制。

```mermaid
flowchart TD
Start([开始测试]) --> EnableError["启用临时读取错误"]
EnableError --> WriteData["写入数据"]
WriteData --> |失败| LogError["记录错误并重试"]
WriteData --> |成功| DisableError["禁用临时读取错误"]
DisableError --> CreateSnapshot["创建快照"]
CreateSnapshot --> EnableErrorAgain["再次启用临时读取错误"]
EnableErrorAgain --> DeleteData["删除数据"]
DeleteData --> |失败| LogErrorAgain["记录错误并重试"]
DeleteData --> |成功| DisableErrorAgain["禁用临时读取错误"]
DisableErrorAgain --> VerifyData["验证数据"]
VerifyData --> End([结束测试])
```

**图源**
- [db_test.go](file://leveldb/db_test.go#L2384-L2417)

### 阻塞同步操作
在`TestDB_SyncRace`测试中，通过`Stall`和`Release`方法控制同步操作的执行时机，验证数据库在并发写入和同步时的行为。

```mermaid
sequenceDiagram
participant Test
participant Storage
participant DB
Test->>Storage : Stall(ModeSync, TypeTable)
Test->>DB : put(k1, large_value)
DB->>Storage : Create(table file)
DB->>Storage : Sync(table file)
Storage->>Storage : 检查是否需要阻塞
Storage-->>DB : 阻塞Sync调用
Test->>DB : put(k2, large_value)
DB->>Storage : Create(table file)
DB->>Storage : Sync(table file)
Storage->>Storage : 检查是否需要阻塞
Storage-->>DB : 阻塞Sync调用
Test->>Storage : Release(ModeSync, TypeTable)
Storage->>Storage : 释放所有阻塞的Sync调用
Storage-->>DB : 继续Sync调用
DB-->>Test : 完成操作
```

**图源**
- [db_test.go](file://leveldb/db_test.go#L638-L650)

**本节源**
- [db_test.go](file://leveldb/db_test.go#L1354-L1517)
- [db_test.go](file://leveldb/db_test.go#L2384-L2417)
- [db_test.go](file://leveldb/db_test.go#L638-L650)

## 总结
`testutil`包中的`Storage`包装器是一个强大的测试工具，它通过嵌入基础`Storage`接口并添加测试专用功能，为数据库的异常条件测试提供了全面的支持。通过错误模拟、随机错误注入、操作计数器和阻塞控制等功能，可以有效地验证系统在各种异常情况下的健壮性和恢复能力。